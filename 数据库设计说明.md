# 云数据库设计说明 - 摊位信息表

## 表名：stalls

### 字段说明

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| _id | String | 是 | 自动生成的文档ID | - |
| _openid | String | 是 | 用户唯一标识（系统自动添加） | - |
| name | String | 是 | 摊位名称 | "老王烧烤摊" |
| description | String | 否 | 摊位描述 | "主营各类烧烤，价格实惠" |
| contact | String | 否 | 联系方式（电话/微信号） | "13800138000" |
| location | GeoPoint | 是 | 地理位置（使用GeoPoint类型） | 见下方格式说明 |
| isOpen | Boolean | 是 | 是否营业中 | true/false |
| createTime | Date | 是 | 创建时间（服务器时间） | - |
| updateTime | Date | 是 | 更新时间（服务器时间） | - |

### location 字段格式

`location` 字段需要使用 **GeoPoint** 类型存储，格式如下：

```javascript
{
  type: "Point",
  coordinates: [longitude, latitude] // [经度, 纬度]
}
```

**示例：**
```javascript
{
  type: "Point",
  coordinates: [116.397428, 39.90923] // 北京天安门坐标
}
```

### 数据库索引设置

为了优化地理位置查询性能，建议在微信云开发控制台为 `stalls` 集合创建以下索引：

1. **地理位置索引（Geo索引）**
   - 字段：`location`
   - 索引类型：2dsphere
   - 说明：用于支持地理位置查询（如果微信云数据库支持）

2. **复合索引**
   - 字段：`isOpen` + `location`
   - 说明：优化查询营业中摊位的性能

### 在微信云开发控制台创建集合

1. 登录微信开发者工具
2. 进入「云开发」->「数据库」
3. 点击「添加集合」，创建名为 `stalls` 的集合
4. 在集合设置中配置索引（如上述说明）

### 注意事项

1. **GeoPoint 格式**：必须严格按照 `{ type: "Point", coordinates: [经度, 纬度] }` 格式存储
2. **坐标系统**：使用 GCJ-02（火星坐标系），这是微信小程序 getLocation API 返回的坐标系统
3. **权限设置**：
   - 读取权限：所有用户可读（用于展示附近摊位）
   - 创建权限：仅创建者可创建
   - 更新权限：仅创建者可更新
   - 删除权限：仅创建者可删除
4. **数据验证**：建议在云函数中添加数据验证逻辑，确保必填字段完整，坐标格式正确

### 查询示例

#### 1. 查询所有营业中的摊位
```javascript
db.collection('stalls')
  .where({
    isOpen: true
  })
  .get()
```

#### 2. 查询附近摊位（在云函数中实现）
由于微信云数据库的 Geo 查询限制，需要在云函数中实现距离计算和筛选，参考 `cloudfunctions/getNearbyStalls/index.js`

#### 3. 更新摊位信息
```javascript
db.collection('stalls')
  .doc(stallId)
  .update({
    data: {
      name: '新名称',
      location: {
        type: 'Point',
        coordinates: [longitude, latitude]
      },
      updateTime: db.serverDate()
    }
  })
```

### 扩展字段建议

如果需要扩展功能，可以考虑添加以下字段：

- `category` (String): 摊位类别（如"餐饮"、"日用品"等）
- `images` (Array): 摊位图片URL数组
- `businessHours` (Object): 营业时间
- `rating` (Number): 评分
- `tags` (Array): 标签数组
